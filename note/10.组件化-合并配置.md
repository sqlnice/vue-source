---
highlight: ir-black
theme: geek-black
---

# ç»„ä»¶åŒ–-åˆå¹¶é…ç½®

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬è®²è¿‡ï¼Œåˆå§‹åŒ– `Vue` å®ä¾‹æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯æ‰‹åŠ¨è°ƒç”¨ `new Vue(options)` çš„æ–¹æ³•ï¼ŒäºŒæ˜¯ä¸ŠèŠ‚è®²åˆ°çš„è°ƒç”¨ `new vnode.componentOptions.Ctor(options)` çš„æ–¹å¼åˆå§‹åŒ–ã€‚
æ— è®ºå“ªç§æ–¹å¼éƒ½ä¼šæ‰§è¡Œåˆ° `_init(options)` æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ `merge options` çš„é€»è¾‘ï¼Œç›¸å…³ä»£ç å®šä¹‰åœ¨ `src/core/instance/init.js` ä¸­ï¼š

```js
Vue.prototype._init = function (options?: Object) {
  // merge options
  if (options && options._isComponent) {
    // optimize internal component instantiation
    // since dynamic options merging is pretty slow, and none of the
    // internal component options needs special treatment.
    initInternalComponent(vm, options);
  } else {
    vm.$options = mergeOptions(
      resolveConstructorOptions(vm.constructor),
      options || {},
      vm
    );
  }
  // ...
};
```

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª ğŸŒ° æ¥çœ‹ä¸€ä¸‹ä¸¤ç§åœºæ™¯çš„ä¸åŒåˆå¹¶è¿‡ç¨‹ï¼š

```js
import Vue from "vue";

let childComp = {
  template: "<div>{{msg}}</div>",
  created() {
    console.log("child created");
  },
  mounted() {
    console.log("child mounted");
  },
  data() {
    return {
      msg: "Hello Vue",
    };
  },
};

Vue.mixin({
  created() {
    console.log("parent created");
  },
});

new Vue({
  el: "#app",
  render: (h) => h(childComp),
});
```

## å¤–éƒ¨è°ƒç”¨åœºæ™¯

ä¸€ï¼š
é¦–å…ˆæ‰§è¡Œ

```js
Vue.mixin({
  created() {
    console.log("parent created");
  },
});
```

`Vue.mixin` æ–¹æ³•æ˜¯åœ¨ `initGlobalAPI` æ–¹æ³•ä¸­ç»™ `Vue` æ„é€ å‡½æ•°èµ‹å€¼ä¸Šçš„ï¼Œå…·ä½“ä»£ç ä¸ºï¼š

```js
import { mergeOptions } from "../util/index";
export function initMixin(Vue: GlobalAPI) {
  Vue.mixin = function (mixin: Object) {
    this.options = mergeOptions(this.options, mixin);
    return this;
  };
}
```

å¯ä»¥çœ‹åˆ° `Vue.mixin` æ¥æ”¶ä¸€ä¸ª `Object`ï¼Œç„¶åè°ƒç”¨ `mergeOptions` åˆå¹¶é…ç½®ã€‚

äºŒï¼š
æ‰§è¡Œ `new Vue(options)`ï¼Œè°ƒç”¨ `this._init(options)`ï¼Œç„¶åå°±æ‰§è¡Œ `_init` å‡½æ•°é‡Œçš„å¦‚ä¸‹é€»è¾‘æ¥åˆå¹¶ `options`ï¼š

```js
vm.$options = mergeOptions(
  resolveConstructorOptions(vm.constructor),
  options || {},
  vm
);
```

`mergeOptions` æ–¹æ³•å®é™…ä¸Šå°±æ˜¯ä¼ å…¥ä¸¤ä¸ª `Object`ï¼Œç„¶ååšåˆå¹¶ã€‚`resolveConstructorOptions(vm.constructor)` æš‚æ—¶ä¸è€ƒè™‘ï¼Œåœ¨è¿™é‡Œå®ƒåªæ˜¯è¿”å›äº† `vm.constructor.options`ï¼Œç›¸å½“äºæ˜¯ `Vue.options`ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼æ˜¯ä»€ä¹ˆï¼Œå…¶å®å®ƒä¹Ÿæ˜¯åœ¨ `initGlobalAPI` æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™å®šä¹‰çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
export function initGlobalAPI(Vue: GlobalAPI) {
  // ...
  Vue.options = Object.create(null);
  ASSET_TYPES.forEach((type) => {
    Vue.options[type + "s"] = Object.create(null);
  });

  // this is used to identify the "base" constructor to extend all plain-object
  // components with in Weex's multi-instance scenarios.
  Vue.options._base = Vue;

  extend(Vue.options.components, builtInComponents);
  // ...
}
```

è¿™æ®µä»£ç çš„ç»“æœç”¨ä»£ç è¡¨ç¤ºå°±æ˜¯ï¼š

```js
Vue.options = {
  components: {
    KeepAlive: {
      name: "keep-alive",
      // ...
    },
  },
  created: [],
  directives: {},
  filters: {},
  _base: Vue,
};
```

å¦å¤–é€šè¿‡ `extend(Vue.options.components, builtInComponents)` æŠŠ `Vue` å†…ç½®çš„ç»„ä»¶(å¦‚ `KeepAlive` )æ‰©å±•åˆ° `Vue.options.components` ä¸­ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åé¢ä½¿ç”¨ `KeepAlive` ä¸ç”¨æ³¨å†Œçš„åŸå› ï¼Œå…³äºç»„ä»¶æ³¨å†Œåé¢å†çœ‹ã€‚

å›åˆ° `mergeOptions` å‡½æ•°ï¼Œå®ƒå®šä¹‰åœ¨ `src/core/util/options.js` ä¸­ï¼š

```js
export function mergeOptions(
  parent: Object,
  child: Object,
  vm?: Component
): Object {
  if (process.env.NODE_ENV !== "production") {
    checkComponents(child);
  }
  if (typeof child === "function") {
    child = child.options;
  }
  // æ ‡å‡†åŒ– propsã€injectã€directive é€‰é¡¹
  normalizeProps(child, vm);
  normalizeInject(child, vm);
  normalizeDirectives(child);
  const extendsFrom = child.extends;
  if (extendsFrom) {
    parent = mergeOptions(parent, extendsFrom, vm);
  }
  if (child.mixins) {
    for (let i = 0, l = child.mixins.length; i < l; i++) {
      parent = mergeOptions(parent, child.mixins[i], vm);
    }
  }
  const options = {};
  let key;
  for (key in parent) {
    mergeField(key);
  }
  for (key in child) {
    if (!hasOwn(parent, key)) {
      mergeField(key);
    }
  }
  // åˆå¹¶å­—æ®µï¼Œchild é€‰é¡¹å°†è¦†ç›–å­é€‰é¡¹
  function mergeField(key) {
    // strats æˆ–è€… defaultStrat æ˜¯ä¸ªåˆå¹¶ç­–ç•¥ï¼Œå³åˆ°åº•ç”¨çˆ¶çš„è¿˜æ˜¯ç”¨å­çš„
    const strat = strats[key] || defaultStrat;
    // ä¼˜å…ˆä½¿ç”¨ child å­é€‰é¡¹çš„å€¼
    options[key] = strat(parent[key], child[key], vm, key);
  }
  return options;
}
```

`mergeOptions` ä¸»è¦åšäº†å‡ ä»¶äº‹ï¼š

1. é€’å½’çš„æŠŠ `extends` å’Œ `mixins` åˆå¹¶åˆ° `parent` ä¸Š
2. éå† `parent`ï¼Œè°ƒç”¨ `mergeField`
3. éå† `child`ï¼Œå¦‚æœ `key` åœ¨ `parent` ä¸Šä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ `mergeField`

æ‰§è¡Œ `mergeField`ï¼Œæ ¹æ®ä¸åŒçš„ `key`ï¼Œè°ƒç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥ï¼Œæ¯”å¦‚å¯¹äºç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼š

```js
function mergeHook(
  parentVal: ?Array<Function>,
  childVal: ?Function | ?Array<Function>
): ?Array<Function> {
  return childVal
    ? parentVal
      ? parentVal.concat(childVal)
      : Array.isArray(childVal)
      ? childVal
      : [childVal]
    : parentVal;
}

[
  "beforeCreate",
  "created",
  "beforeMount",
  "mounted",
  "beforeUpdate",
  "updated",
  "beforeDestroy",
  "destroyed",
  "activated",
  "deactivated",
  "errorCaptured", // 2.5.0 æ–°å¢çš„é’©å­
].forEach((hook) => {
  strats[hook] = mergeHook;
});
```

è¿™é‡Œå®šä¹‰äº† `Vue` ä¸­çš„æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œ`mergeHook` æ‰§è¡Œçš„ç»“æœå°±æ˜¯æŠŠ `child` å’Œ `parent` ä¸­å®šä¹‰çš„æ¯”å¦‚ `created(){}` åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„å¹¶è¿”å›ã€‚
å…¶ä»–ç­–ç•¥å®šä¹‰éƒ½å¯ä»¥åœ¨ `src/core/util/options.js` çœ‹åˆ°ï¼Œè¿™é‡Œä¸ä¸€ä¸€ç»†çœ‹äº†ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬æœ€åæ‰§è¡Œå®Œåˆå¹¶é…ç½®åï¼š

```js
vm.$options = mergeOptions(
  resolveConstructorOptions(vm.constructor),
  options || {},
  vm
);
```

`vm.$options` çš„å€¼åº”è¯¥ä¸ºï¼š

```js
vm.$options = {
  components: {}
  created: [
    function created() {
      console.log('parent created')
    }
  ]
  directives: {}
  el: "#app"
  filters: {}
  render: function render(h) {}
  _base: function Vue(options) {}
}
```

## ç»„ä»¶è°ƒç”¨åœºæ™¯

æˆ‘ä»¬åœ¨ä¹‹å‰äº†è§£åˆ°ç»„ä»¶çš„æ„é€ å‡½æ•°æ˜¯é€šè¿‡ `Vue.extend` ç»§æ‰¿è‡ª `Vue` çš„ï¼Œå…·ä½“ä»£ç å®šä¹‰åœ¨ `src/core/global-api/extend.js` ä¸­ï¼š

```js
Vue.extend = function (extendOptions: Object): Function {
  // ...
  Sub.options = mergeOptions(Super.options, extendOptions);

  // ...
  // keep a reference to the super options at extension time.
  // later at instantiation we can check if Super's options have
  // been updated.
  Sub.superOptions = Super.options;
  Sub.extendOptions = extendOptions;
  Sub.sealedOptions = extend({}, Sub.options);

  // ...
  return Sub;
};
```

è¿™é‡Œä¼ å…¥çš„ `extendOptions` å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ç»„ä»¶å¯¹è±¡ `let childComp = { //... }`ï¼Œä»–ä¼šå’Œ `Vue.options` åˆå¹¶åˆ° `Sub.options` ä¸­ã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šçœ‹ä¸€ä¸‹ç»„ä»¶åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œå®šä¹‰åœ¨ `src/core/vdom/create-component.js` ä¸­ï¼š

```js
export function createComponentInstanceForVnode(
  vnode: any, // we know it's MountedComponentVNode but flow doesn't
  parent: any // activeInstance in lifecycle state
): Component {
  const options: InternalComponentOptions = {
    _isComponent: true,
    _parentVnode: vnode,
    parent,
  };
  // ...
  return new vnode.componentOptions.Ctor(options);
}
```

åœ¨è¿™é‡Œ `vnode.componentOptions.Ctor = Sub`ï¼Œæ‰€ä»¥æ‰§è¡Œçš„ä¸‹ä¸€æ­¥å°±æ˜¯è°ƒç”¨ `_init(options)` æ–¹æ³•ã€‚å› ä¸º `_isComponent = true`ï¼Œæ‰€ä»¥åˆå¹¶é…ç½®èµ°åˆ° `initInternalComponent(vm, options)`ï¼Œ`initInternalComponent` å®šä¹‰åœ¨ `src/core/instance/init.js` ä¸­ï¼š

```js
export function initInternalComponent(
  vm: Component,
  options: InternalComponentOptions
) {
  const opts = (vm.$options = Object.create(vm.constructor.options));
  // doing this because it's faster than dynamic enumeration.
  const parentVnode = options._parentVnode;
  opts.parent = options.parent;
  opts._parentVnode = parentVnode;

  const vnodeComponentOptions = parentVnode.componentOptions;
  opts.propsData = vnodeComponentOptions.propsData;
  opts._parentListeners = vnodeComponentOptions.listeners;
  opts._renderChildren = vnodeComponentOptions.children;
  opts._componentTag = vnodeComponentOptions.tag;

  if (options.render) {
    opts.render = options.render;
    opts.staticRenderFns = options.staticRenderFns;
  }
}
```

`initInternalComponent` ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š

1. æ‰§è¡Œ `const opts = vm.$options = Object.create(vm.constructor.options)`ï¼Œä¹Ÿå°±æ˜¯ `vm.$options = Object.create(Sub.options)`
2. æŠŠå®ä¾‹åŒ–å­ç»„ä»¶ä¼ å…¥çš„å­ç»„ä»¶ `çˆ¶ VNode` å®ä¾‹ `parentVnode`ã€å­ç»„ä»¶çš„ `çˆ¶ Vue å®ä¾‹` `parent` ä¿å­˜åˆ° `vm.$options` ä¸­
3. ä¿ç•™äº† `parentVnode` é…ç½®ä¸­çš„å¦‚ `propsData` ç­‰å…¶å®ƒçš„å±æ€§

å¹¶æ²¡æœ‰åƒ `mergeOptions` ä¸€æ ·é€’å½’ã€åˆå¹¶ç­–ç•¥ç­‰é€»è¾‘ã€‚

å› æ­¤æ‰§è¡Œå®Œ `initInternalComponent` ä¹‹åï¼Œ`vm.$options` çš„å€¼åº”è¯¥ä¸ºï¼š

```js
vm.$options = {
  parent: Vue, // çˆ¶Vueå®ä¾‹
  propsData: undefined,
  _componentTag: undefined,
  _parentListeners: undefined,
  _renderChildren: undefined,
  _parentVnode: VNode, // çˆ¶VNodeå®ä¾‹
  __proto__: {
    components: {},
    created: [
      function created() {
        console.log("parent created");
      },
      function created() {
        console.log("child created");
      },
    ],
    data() {
      return {
        msg: "Hello Vue",
      };
    },
    directives: {},
    filters: {},
    mounted: [
      function mounted() {
        console.log("child mounted");
      },
    ],
    template: "<div>{{msg}}</div>",
    _Ctor: {},
    _base: function Vue(options) {
      //...
    },
  },
};
```

## æ€»ç»“

![09.ç»„ä»¶åŒ–-åˆå¹¶é…ç½®.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/083edcb8403a40cc9a8fadce5b0873be~tplv-k3u1fbpfcp-watermark.image?)

æœ¬æ–‡æ€»ç»“äº†ä¸¤ç§åˆå§‹åŒ– `Vue` çš„åˆå¹¶é…ç½®è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“å¯¹äº `options` æœ‰ä¸¤ç§åˆå¹¶æ–¹å¼ï¼Œç»„ä»¶é€šè¿‡è°ƒç”¨ `initInternalComponent` æ¯”å¤–éƒ¨è°ƒç”¨ `Vue` åˆå§‹åŒ–çš„è¿‡ç¨‹è¦å¿«ï¼Œåˆå¹¶å®Œçš„ç»“æœå­˜æ”¾åœ¨ `vm.$options` ä¸­ã€‚

> çºµè§‚ä¸€äº›åº“ã€æ¡†æ¶çš„è®¾è®¡å‡ ä¹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œè‡ªèº«å®šä¹‰äº†ä¸€äº›é»˜è®¤é…ç½®ï¼ŒåŒæ—¶åˆå¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¼ å…¥ä¸€äº›å®šä¹‰é…ç½®ï¼Œç„¶åå» merge é»˜è®¤é…ç½®ï¼Œæ¥è¾¾åˆ°å®šåˆ¶åŒ–ä¸åŒéœ€æ±‚çš„ç›®çš„ã€‚åªä¸è¿‡åœ¨ Vue çš„åœºæ™¯ä¸‹ï¼Œä¼šå¯¹ merge çš„è¿‡ç¨‹åšä¸€äº›ç²¾ç»†åŒ–æ§åˆ¶ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å¼€å‘è‡ªå·±çš„ JSSDK çš„æ—¶å€™å¹¶æ²¡æœ‰ Vue è¿™ä¹ˆå¤æ‚ï¼Œä½†è¿™ä¸ªè®¾è®¡æ€æƒ³æ˜¯å€¼å¾—æˆ‘ä»¬å€Ÿé‰´çš„ã€‚ - Vue.js æŠ€æœ¯æ­ç§˜

> [æºç åˆ†æ GitHub åœ°å€](https://github.com/sqlnice/vue-resource)

> å‚è€ƒï¼š[Vue.js æŠ€æœ¯æ­ç§˜](https://ustbhuangyi.github.io/vue-analysis/)
