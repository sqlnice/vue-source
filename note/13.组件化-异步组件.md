---
highlight: ir-black
theme: geek-black
---

# ç»„ä»¶åŒ–-å¼‚æ­¥ç»„ä»¶

åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†å‡å°‘æ‰“åŒ…ä½“ç§¯æˆ–ä¸ºäº†åŠ å¿«é¦–å±çš„è®°è½½é€Ÿåº¦ï¼Œä¼šæŠŠä»£ç å—è¿›è¡Œåˆ†å‰²ï¼Œåªæœ‰åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰åŠ è½½ï¼Œä¸ºæ­¤ `Vue` æä¾›äº†å¼‚æ­¥ç»„ä»¶ï¼Œå®ƒå…è®¸æˆ‘ä»¬ç”¨å·¥å‚å‡½æ•°çš„æ–¹å¼æ¥å®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ªå·¥å‚å‡½æ•°ä¼šå¼‚æ­¥è§£ææˆ‘ä»¬å®šä¹‰çš„ç»„ä»¶å®šä¹‰ï¼Œåªæœ‰åœ¨ç»„ä»¶éœ€è¦è¢«æ¸²æŸ“çš„æ—¶å€™æ‰ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚

ä¸‹é¢æ˜¯å¼‚æ­¥ç»„ä»¶çš„å‡ ç§ä½¿ç”¨æ–¹å¼ï¼ˆ[å®˜ç½‘ï¼šå¼‚æ­¥ç»„ä»¶](https://cn.vuejs.org/v2/guide/components-dynamic-async.html#%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6)ï¼‰ï¼š

```js
// ä¸€ï¼šæ™®é€šå‡½æ•°å¼‚æ­¥ç»„ä»¶
Vue.component("async-webpack-example", function (resolve) {
  // è¿™ä¸ªç‰¹æ®Šçš„ `require` è¯­æ³•å°†ä¼šå‘Šè¯‰ webpack
  // è‡ªåŠ¨å°†ä½ çš„æ„å»ºä»£ç åˆ‡å‰²æˆå¤šä¸ªåŒ…ï¼Œè¿™äº›åŒ…
  // ä¼šé€šè¿‡ Ajax è¯·æ±‚åŠ è½½
  require(["./my-async-component"], resolve);
});

// äºŒï¼šPromise å¼‚æ­¥ç»„ä»¶
Vue.component(
  "async-webpack-example",
  // è¿™ä¸ªåŠ¨æ€å¯¼å…¥ä¼šè¿”å›ä¸€ä¸ª `Promise` å¯¹è±¡ã€‚
  () => import("./my-async-component")
);

// ä¸‰ï¼šé«˜çº§å¼‚æ­¥ç»„ä»¶
const AsyncComponent = () => ({
  // éœ€è¦åŠ è½½çš„ç»„ä»¶ (åº”è¯¥æ˜¯ä¸€ä¸ª `Promise` å¯¹è±¡)
  component: import("./MyComponent.vue"),
  // å¼‚æ­¥ç»„ä»¶åŠ è½½æ—¶ä½¿ç”¨çš„ç»„ä»¶
  loading: LoadingComponent,
  // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶
  error: ErrorComponent,
  // å±•ç¤ºåŠ è½½æ—¶ç»„ä»¶çš„å»¶æ—¶æ—¶é—´ã€‚é»˜è®¤å€¼æ˜¯ 200 (æ¯«ç§’)
  delay: 200,
  // å¦‚æœæä¾›äº†è¶…æ—¶æ—¶é—´ä¸”ç»„ä»¶åŠ è½½ä¹Ÿè¶…æ—¶äº†ï¼Œ
  // åˆ™ä½¿ç”¨åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶ã€‚é»˜è®¤å€¼æ˜¯ï¼š`Infinity`
  timeout: 3000,
});
Vue.component("async-example", AsyncComp);
```

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å¼‚æ­¥ç»„ä»¶çš„å¤§æ¦‚æµç¨‹ï¼Œç„¶åå†åˆ†æä¸‰ç§æ–¹å¼çš„å·®å¼‚åœ¨å“ªé‡Œã€‚
åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº† [12.ç»„ä»¶åŒ–-ç»„ä»¶æ³¨å†Œ](https://juejin.cn/post/7070748062150295559) çš„é€»è¾‘ï¼Œç”±äºç»„ä»¶çš„å®šä¹‰ä¸æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ `Vue.extend` çš„é€»è¾‘æŠŠå®ƒå˜æˆä¸€ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å®ƒä»ç„¶å¯ä»¥æ‰§è¡Œåˆ° `createComponent` å‡½æ•°ï¼Œ`createComponent` å®šä¹‰åœ¨ `src/core/vdom/create-component/js` ä¸­ï¼š

```js
export function createComponent(
  Ctor: Class<Component> | Function | Object | void,
  data: ?VNodeData,
  context: Component,
  children: ?Array<VNode>,
  tag?: string
): VNode | Array<VNode> | void {
  if (isUndef(Ctor)) {
    return;
  }

  const baseCtor = context.$options._base;

  // plain options object: turn it into a constructor
  if (isObject(Ctor)) {
    Ctor = baseCtor.extend(Ctor);
  }

  // ...

  // async component
  let asyncFactory;
  if (isUndef(Ctor.cid)) {
    asyncFactory = Ctor;
    Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context);
    if (Ctor === undefined) {
      // return a placeholder node for async component, which is rendered
      // as a comment node but preserves all the raw information for the node.
      // the information will be used for async server-rendering and hydration.
      return createAsyncPlaceholder(asyncFactory, data, context, children, tag);
    }
  }
}
```

ç”±äºæˆ‘ä»¬ä¼ å…¥çš„ `Ctor` å‚æ•°æ˜¯ä¸€ä¸ª `Function`ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¯¹è±¡ï¼Œ`Ctor` ä¸Šé¢ä¹Ÿæ²¡æœ‰ `id`ï¼Œæ‰€ä»¥æ‰§è¡Œ `Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context)`ï¼Œ`resolveAsyncComponent` å®šä¹‰åœ¨ `src/core/vdom/helpers/resolve-async-component.js` ä¸­ï¼š

```js
export function resolveAsyncComponent(
  factory: Function,
  baseCtor: Class<Component>,
  context: Component
): Class<Component> | void {
  if (isTrue(factory.error) && isDef(factory.errorComp)) {
    return factory.errorComp;
  }

  if (isDef(factory.resolved)) {
    return factory.resolved;
  }

  if (isTrue(factory.loading) && isDef(factory.loadingComp)) {
    return factory.loadingComp;
  }

  if (isDef(factory.contexts)) {
    // already pending
    factory.contexts.push(context);
  } else {
    const contexts = (factory.contexts = [context]);
    let sync = true;

    const forceRender = () => {
      for (let i = 0, l = contexts.length; i < l; i++) {
        contexts[i].$forceUpdate();
      }
    };

    const resolve = once((res: Object | Class<Component>) => {
      // cache resolved
      factory.resolved = ensureCtor(res, baseCtor);
      // invoke callbacks only if this is not a synchronous resolve
      // (async resolves are shimmed as synchronous during SSR)
      if (!sync) {
        forceRender();
      }
    });

    const reject = once((reason) => {
      process.env.NODE_ENV !== "production" &&
        warn(
          `Failed to resolve async component: ${String(factory)}` +
            (reason ? `\nReason: ${reason}` : "")
        );
      if (isDef(factory.errorComp)) {
        factory.error = true;
        forceRender();
      }
    });

    const res = factory(resolve, reject);

    if (isObject(res)) {
      if (typeof res.then === "function") {
        // () => Promise
        if (isUndef(factory.resolved)) {
          res.then(resolve, reject);
        }
      } else if (
        isDef(res.component) &&
        typeof res.component.then === "function"
      ) {
        res.component.then(resolve, reject);

        if (isDef(res.error)) {
          factory.errorComp = ensureCtor(res.error, baseCtor);
        }

        if (isDef(res.loading)) {
          factory.loadingComp = ensureCtor(res.loading, baseCtor);
          if (res.delay === 0) {
            factory.loading = true;
          } else {
            setTimeout(() => {
              if (isUndef(factory.resolved) && isUndef(factory.error)) {
                factory.loading = true;
                forceRender();
              }
            }, res.delay || 200);
          }
        }

        if (isDef(res.timeout)) {
          setTimeout(() => {
            if (isUndef(factory.resolved)) {
              reject(
                process.env.NODE_ENV !== "production"
                  ? `timeout (${res.timeout}ms)`
                  : null
              );
            }
          }, res.timeout);
        }
      }
    }

    sync = false;
    // return in case resolved synchronously
    return factory.loading ? factory.loadingComp : factory.resolved;
  }
}
```

`resolveAsyncComponent` å‡½æ•°é€»è¾‘å¤æ‚çš„åŸå› å°±æ˜¯å®ƒå¤„ç†äº†æˆ‘ä»¬å¼€å¤´è®²çš„æ³¨å†Œå¼‚æ­¥ç»„ä»¶çš„ä¸‰ç§æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‰ç§æ–¹å¼çš„ä¸åŒé€»è¾‘ã€‚

### æ™®é€šå‡½æ•°å¼‚æ­¥ç»„ä»¶

```js
// ä¸€ï¼šæ™®é€šå‡½æ•°å¼‚æ­¥ç»„ä»¶
Vue.component("async-webpack-example", function (resolve) {
  // è¿™ä¸ªç‰¹æ®Šçš„ `require` è¯­æ³•å°†ä¼šå‘Šè¯‰ webpack
  // è‡ªåŠ¨å°†ä½ çš„æ„å»ºä»£ç åˆ‡å‰²æˆå¤šä¸ªåŒ…ï¼Œè¿™äº›åŒ…
  // ä¼šé€šè¿‡ Ajax è¯·æ±‚åŠ è½½
  require(["./my-async-component"], resolve);
});
```

é¦–å…ˆä¼ è¿›æ¥çš„ `factory` æ˜¯ä¸€ä¸ª `Function`ï¼Œæ‰€ä»¥å‰é¢çš„å‡ ä¸ª `if` å¯ä»¥å¿½ç•¥ï¼Œå¯¹äº `factory.contexts` çš„åˆ¤æ–­ï¼Œæ˜¯è€ƒè™‘åˆ°å¤šä¸ªåœ°æ–¹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªå¼‚æ­¥ç»„ä»¶ï¼Œé‚£ä¹ˆå®ƒçš„å®é™…åŠ è½½åº”è¯¥åªæœ‰ä¸€æ¬¡ã€‚ç„¶åå®šä¹‰äº† `forceRender`ã€`resolve` å’Œ `reject` å‡½æ•°ï¼Œæ³¨æ„åˆ° `resolve` å’Œ `reject` å‡½æ•°ç”¨ `once` åŒ…äº†ä¸€å±‚ï¼Œ`once` çš„ä½œç”¨å°±æ˜¯åˆ©ç”¨é—­åŒ…å’Œæ ‡è¯†ç¬¦ä¿è¯å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå³ä¸º [å•ä¾‹æ¨¡å¼](https://juejin.cn/post/6898673196212420622)ã€‚

æ¥ä¸‹æ¥æ‰§è¡Œ `const res = factory(resolve, reject)`ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å®šä¹‰çš„ç»„ä»¶å·¥å‚å‡½æ•°ï¼ŒåŒæ—¶æŠŠ `resolve` å’Œ `reject` ä¼ å…¥ï¼Œç»„ä»¶çš„å·¥å‚å‡½æ•°ä¼šå‘é€è¯·æ±‚åŠ è½½æˆ‘ä»¬çš„å¼‚æ­¥ç»„ä»¶ï¼Œæ‹¿åˆ°ç»„ä»¶æ–‡ä»¶å¯¼å‡ºçš„ `Object` åæ‰§è¡Œ `resolve(res)`ï¼Œå³æ‰§è¡Œï¼š

```js
const resolve = once((res: Object | Class<Component>) => {
  // cache resolved
  factory.resolved = ensureCtor(res, baseCtor);
  // invoke callbacks only if this is not a synchronous resolve
  // (async resolves are shimmed as synchronous during SSR)
  if (!sync) {
    forceRender();
  }
});
```

ç„¶åæ‰§è¡Œ `factory.resolved = ensureCtor(res, baseCtor)`

```js
function ensureCtor(comp: any, base) {
  if (comp.__esModule || (hasSymbol && comp[Symbol.toStringTag] === "Module")) {
    comp = comp.default;
  }
  return isObject(comp) ? base.extend(comp) : comp;
}
```

è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½ä¿è¯æ‰¾åˆ°ç»„ä»¶å®šä¹‰çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡åˆ™è°ƒç”¨ `base.extend` è½¬æ¢ä¸º `Vue` å®ä¾‹çš„å­æ„é€ å‡½æ•°ã€‚

`resolve` å‡½æ•°æœ€åæ‰§è¡Œ `forceRender` å‡½æ•°ï¼Œä»–ä¼šéå† `contexts`ï¼Œæ‹¿åˆ°æ¯ä¸€ä¸ª **è°ƒç”¨** å¼‚æ­¥ç»„ä»¶çš„å®ä¾‹ `vm`ï¼Œæ‰§è¡Œ `vm.$forceUpdate()`

```js
Vue.prototype.$forceUpdate = function () {
  const vm: Component = this;
  if (vm._watcher) {
    vm._watcher.update();
  }
};
```

`$forceUpdate` çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯è°ƒç”¨æ¸²æŸ“ `watcher` çš„ `update` æ–¹æ³•ï¼Œè®©æ¸²æŸ“ `watcher` å¯¹åº”çš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è§¦å‘äº†ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšæ˜¯å› ä¸º `Vue` é€šå¸¸æ˜¯æ•°æ®é©±åŠ¨è§†å›¾é‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯åœ¨æ•´ä¸ªå¼‚æ­¥ç»„ä»¶åŠ è½½è¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰æ•°æ®å‘ç”Ÿå˜åŒ–çš„ï¼Œæ‰€ä»¥é€šè¿‡æ‰§è¡Œ `$forceUpdate` å¯ä»¥å¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡ã€‚

### Promise å¼‚æ­¥ç»„ä»¶

åœ¨ `webpack 2+` å’Œ `ES2015` çš„æ”¯æŒä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼‚æ­¥åŠ è½½çš„è¯­æ³•ç³– ğŸ¬ï¼Œå¯¼å…¥è¿”å› `Promise` çš„ç»„ä»¶

```js
// äºŒï¼šPromise å¼‚æ­¥ç»„ä»¶
Vue.component(
  "async-webpack-example",
  // è¿™ä¸ªåŠ¨æ€å¯¼å…¥ä¼šè¿”å›ä¸€ä¸ª `Promise` å¯¹è±¡ã€‚
  () => import("./my-async-component")
);
```

å½“æ‰§è¡Œå®Œ `const res = factory(resolve, reject)` åï¼Œä¼šè¿”å›ä¸€ä¸ª `Promise å¯¹è±¡`ï¼Œè¿›å…¥ `if` æ¡ä»¶ï¼š

```js
if (isUndef(factory.resolved)) {
  res.then(resolve, reject);
}
```

å½“å¼‚æ­¥åŠ è½½æˆåŠŸä¹‹åï¼Œæ‰§è¡Œ `resolve`ï¼Œå¦åˆ™æ‰§è¡Œ `reject`ï¼Œåˆå›åˆ°äº†ä¸Šé¢æ™®é€šå¼‚æ­¥ç»„ä»¶çš„é€»è¾‘ã€‚

### é«˜çº§å¼‚æ­¥ç»„ä»¶

ç”±äºå¼‚æ­¥åŠ è½½ç»„ä»¶æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œæ¯”å¦‚ç½‘ç»œæ³¢åŠ¨æˆ–è€…å…¶ä»–é—®é¢˜ï¼Œæ‰€ä»¥ `Vue 2.3+` æ”¯æŒä¸€ç§é«˜çº§å¼‚æ­¥ç»„ä»¶çš„æ–¹å¼ï¼Œé‡Œé¢å¯ä»¥é…ç½® `error` å’Œ `loading`ï¼Œå¹¶åœ¨åˆé€‚æ—¶æœºä¼šæ¸²æŸ“ä»–ä»¬ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

```js
// ä¸‰ï¼šé«˜çº§å¼‚æ­¥ç»„ä»¶
const AsyncComponent = () => ({
  // éœ€è¦åŠ è½½çš„ç»„ä»¶ (åº”è¯¥æ˜¯ä¸€ä¸ª `Promise` å¯¹è±¡)
  component: import("./MyComponent.vue"),
  // å¼‚æ­¥ç»„ä»¶åŠ è½½æ—¶ä½¿ç”¨çš„ç»„ä»¶
  loading: LoadingComponent,
  // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶
  error: ErrorComponent,
  // å±•ç¤ºåŠ è½½æ—¶ç»„ä»¶çš„å»¶æ—¶æ—¶é—´ã€‚é»˜è®¤å€¼æ˜¯ 200 (æ¯«ç§’)
  delay: 200,
  // å¦‚æœæä¾›äº†è¶…æ—¶æ—¶é—´ä¸”ç»„ä»¶åŠ è½½ä¹Ÿè¶…æ—¶äº†ï¼Œ
  // åˆ™ä½¿ç”¨åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨çš„ç»„ä»¶ã€‚é»˜è®¤å€¼æ˜¯ï¼š`Infinity`
  timeout: 3000,
});
Vue.component("async-example", AsyncComp);
```

é«˜çº§å¼‚æ­¥ç»„ä»¶å’Œæ™®é€šå¼‚æ­¥ç»„ä»¶çš„åˆå§‹åŒ–é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æ‰§è¡Œ `resolveAsyncComponet`ï¼Œå½“æ‰§è¡Œå®Œ `const res = factory(resolve, reject)` åï¼Œè¿”å›å€¼å°±æ˜¯å®šä¹‰çš„å¯¹è±¡ï¼Œæ‰€ä»¥èµ°åˆ°äº†ä¸‹é¢çš„é€»è¾‘ï¼š

```js
if (typeof res.then === "function") {
} else if (isDef(res.component) && typeof res.component.then === "function") {
  res.component.then(resolve, reject);

  if (isDef(res.error)) {
    factory.errorComp = ensureCtor(res.error, baseCtor);
  }

  if (isDef(res.loading)) {
    factory.loadingComp = ensureCtor(res.loading, baseCtor);
    if (res.delay === 0) {
      factory.loading = true;
    } else {
      setTimeout(() => {
        if (isUndef(factory.resolved) && isUndef(factory.error)) {
          factory.loading = true;
          forceRender();
        }
      }, res.delay || 200);
    }
  }

  if (isDef(res.timeout)) {
    setTimeout(() => {
      if (isUndef(factory.resolved)) {
        reject(
          process.env.NODE_ENV !== "production"
            ? `timeout (${res.timeout}ms)`
            : null
        );
      }
    }, res.timeout);
  }
}
```

é¦–å…ˆæ‰§è¡Œ `res.component.then(resolve, reject)`ï¼Œå½“åŠ è½½æˆåŠŸåæ‰§è¡Œ `resolve`ï¼Œå¤±è´¥æ‰§è¡Œ `reject`ï¼Œç„¶åå†æ‰§è¡Œï¼š

```js
if (isDef(res.error)) {
  factory.errorComp = ensureCtor(res.error, baseCtor);
}

if (isDef(res.loading)) {
  factory.loadingComp = ensureCtor(res.loading, baseCtor);
  if (res.delay === 0) {
    factory.loading = true;
  } else {
    setTimeout(() => {
      if (isUndef(factory.resolved) && isUndef(factory.error)) {
        factory.loading = true;
        forceRender();
      }
    }, res.delay || 200);
  }
}

if (isDef(res.timeout)) {
  setTimeout(() => {
    if (isUndef(factory.resolved)) {
      reject(
        process.env.NODE_ENV !== "production"
          ? `timeout (${res.timeout}ms)`
          : null
      );
    }
  }, res.timeout);
}
```

æ ¹æ® `res` çš„å€¼å†…å®¹ï¼Œåˆ†åˆ«è®¾ç½® `factory.errorComp` å’Œ `factor.loadingComp`ã€‚åœ¨è®¾ç½® `loading` ç»„ä»¶çš„æ—¶å€™è®¾ç½® `delay`ã€‚å¦‚æœå®šä¹‰äº† `timeout`ï¼Œåˆ™å†è¶…æ—¶æ—¶é—´ä¹‹ååˆ¤æ–­æœ‰æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå¦‚æœæ²¡åŠ è½½æˆåŠŸçš„è¯è°ƒç”¨ `reject`ã€‚

åœ¨ `resolveAsyncComponent` æœ€åè¿˜æœ‰ä¸€æ®µä»£ç ï¼š

```js
sync = false;
return factory.loading ? factory.loadingComp : factory.resolved;
```

å¦‚æœ `delay` ä¸º `0`ï¼Œåˆ™ç›´æ¥æ¸²æŸ“ `loading` ç»„ä»¶ï¼Œå¦åˆ™å»¶æ—¶ `delay` æ‰§è¡Œ `forceRender`ï¼Œé‚£ä¹ˆåˆå†ä¸€æ¬¡æ‰§è¡Œåˆ° `resolveAsyncComponent`ã€‚

æœ€åçœ‹ä¸€ä¸‹åŠ è½½ç»„ä»¶çš„è¾¹ç•Œå¤„ç†ï¼š

#### å¼‚æ­¥ç»„ä»¶åŠ è½½å¤±è´¥

ä¼šæ‰§è¡Œ `reject` å‡½æ•°ï¼š

```js
const reject = once((reason) => {
  process.env.NODE_ENV !== "production" &&
    warn(
      `Failed to resolve async component: ${String(factory)}` +
        (reason ? `\nReason: ${reason}` : "")
    );
  if (isDef(factory.errorComp)) {
    factory.error = true;
    forceRender();
  }
});
```

è¿™æ—¶ä¼šæŠŠ `factory.error` è®¾ç½®ä¸º `true`ï¼Œå¹¶æ‰§è¡Œ `forceRender`ï¼Œé‡æ–°æ‰§è¡Œ `resolveAsyncComponent`ï¼š

```js
if (isTrue(factory.error) && isDef(factory.errorComp)) {
  return factory.errorComp;
}
```

è¿™ä¸ªæ—¶å€™å°±ä¼šç›´æ¥æ¸²æŸ“ `errorComp` ç»„ä»¶ã€‚

#### å¼‚æ­¥ç»„ä»¶åŠ è½½æˆåŠŸ

ä¼šæ‰§è¡Œ `resolve` å‡½æ•°ï¼š

```js
const resolve = once((res: Object | Class<Component>) => {
  factory.resolved = ensureCtor(res, baseCtor);
  if (!sync) {
    forceRender();
  }
});
```

é¦–å…ˆæŠŠç»“æœç¼“å­˜åˆ° `factory.resolved` ä¸­ï¼Œå› ä¸ºè¿™æ—¶ `sync` ä¸º `false`ï¼Œæ‰€ä»¥æ‰§è¡Œ `forceRender`ï¼Œé‡æ–°æ‰§è¡Œ `resolveAsyncComponent`ï¼Œæ¸²æŸ“åŠ è½½æˆåŠŸçš„ç»„ä»¶ã€‚

#### å¼‚æ­¥ç»„ä»¶åŠ è½½ä¸­

å¦‚æœå¼‚æ­¥ç»„ä»¶æ­£åœ¨åŠ è½½ä¸­ï¼Œåˆ™ï¼š

```js
if (isTrue(factory.loading) && isDef(factory.loadingComp)) {
  return factory.loadingComp;
}
```

ç›´æ¥è¿”å› `loadingComp`ï¼Œæ¸²æŸ“ `loading` ç»„ä»¶ã€‚

#### å¼‚æ­¥ç»„ä»¶åŠ è½½è¶…æ—¶

å¦‚æœè¶…æ—¶ï¼Œåˆ™èµ° `reject` é€»è¾‘ï¼Œæ¸²æŸ“ `error` ç»„ä»¶ã€‚

### å¼‚æ­¥ç»„ä»¶ patch

è®©æˆ‘ä»¬å›åˆ°æœ¬æ–‡ä¸€å¼€å§‹çš„ `createComponent` å‡½æ•°ï¼š

```js
Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context);
if (Ctor === undefined) {
  return createAsyncPlaceholder(asyncFactory, data, context, children, tag);
}
```

å¦‚æœä¸æ˜¯ç”¨é«˜çº§å¼‚æ­¥ç»„ä»¶ `0 delay` åˆ›å»ºçš„ `loading` ç»„ä»¶ï¼Œåˆ™è¿”å›çš„æ˜¯ `undefined`ï¼Œæ¥ç€ä¼šè°ƒç”¨ `createAsyncPlaceholder` æ¥åˆ›å»ºä¸€ä¸ªå ä½ç¬¦èŠ‚ç‚¹ã€‚

`createAsyncPlaceholder` å®šä¹‰åœ¨ `src/core/vdom/helpers/resolve-async-components.js` ä¸­ï¼š

```js
export function createAsyncPlaceholder(
  factory: Function,
  data: ?VNodeData,
  context: Component,
  children: ?Array<VNode>,
  tag: ?string
): VNode {
  const node = createEmptyVNode();
  node.asyncFactory = factory;
  node.asyncMeta = { data, context, children, tag };
  return node;
}
```

`createAsyncPlaceholder` ä¼šåˆ›å»ºä¸€ä¸ªå ä½ç¬¦ `vnode`ï¼Œç„¶åæŠŠ `asyncFactory` å’Œ `asyncMeta` èµ‹å€¼ç»™ `vnode`ã€‚å½“æ‰§è¡Œ `forceRender` æ—¶ï¼Œè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œé‚£ä¹ˆä¼šå†æ¬¡æ‰§è¡Œ `resolveAsyncComponent`ã€‚è¿™æ—¶å°±ä¼šæ ¹æ®æƒ…å†µè¿”å› `loading`ã€`error` æˆ–è€…åŠ è½½æˆåŠŸçš„ç»„ä»¶ï¼Œè¿”å›å€¼ä¸ä¸º `undefined`ï¼Œå› æ­¤å°±èµ°æ­£å¸¸çš„ç»„ä»¶ `render`ã€`patch` è¿‡ç¨‹ï¼Œä¸ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“æµç¨‹ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯å­˜åœ¨æ–°æ—§ `vnode`çš„ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬ä¼šåˆ†æç»„ä»¶æ›´æ–°çš„ `patch` è¿‡ç¨‹ã€‚

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¼‚æ­¥ç»„ä»¶çš„ä¸‰ç§å®ç°æ–¹å¼ï¼Œå¹¶ä¸”é«˜çº§å¼‚æ­¥ç»„ä»¶çš„å®ç°éå¸¸æœ‰æ„æ€ã€‚å®ƒå®ç°äº† `loading`ã€`resolve`ã€`reject`ã€`timeout` å››ç§çŠ¶æ€ã€‚

å¼‚æ­¥ç»„ä»¶çš„æœ¬è´¨æ˜¯äºŒæ¬¡æ¸²æŸ“ï¼Œéƒ½æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ç”Ÿæˆä¸€ä¸ªå ä½ç¬¦èŠ‚ç‚¹ï¼Œç„¶åç»„ä»¶è·å–æˆåŠŸä¹‹åï¼Œå†é€šè¿‡ `forceRender` å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼Œä½† `0 delay` çš„é«˜çº§å¼‚æ­¥ç»„ä»¶æ˜¯ä¸ªä¾‹å¤–ï¼Œä»–ç¬¬ä¸€æ¬¡æ˜¯ç›´æ¥æ¸²æŸ“ `loading` ç»„ä»¶ã€‚

![13.ç»„ä»¶åŒ–-å¼‚æ­¥ç»„ä»¶.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4fce2232c9934f2b98e5dbb7bece6d97~tplv-k3u1fbpfcp-watermark.image?)

> [æºç åˆ†æ GitHub åœ°å€](https://github.com/sqlnice/vue-resource)

> å‚è€ƒï¼š[Vue.js æŠ€æœ¯æ­ç§˜](https://ustbhuangyi.github.io/vue-analysis/)
